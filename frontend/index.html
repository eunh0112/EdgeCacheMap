<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <title>EdgeCacheMap</title>
  <script type="text/javascript"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8dc498e5a0513820fb29762cc5b64689&autoload=false" defer>
    </script>
  <style>
    #map {
      width: 100%;
      height: 600px;
    }

    .buttons {
      margin: 10px 0;
    }

    .buttons button {
      margin-right: 5px;
      padding: 6px 12px;
      border: none;
      background-color: #eee;
      cursor: pointer;
    }

    .buttons button.active {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>

<body>
  <h2>ğŸ“ ì§€ë„ ê¸°ë°˜ ë§›ì§‘ ì¶”ì²œ ì‹œìŠ¤í…œ</h2>

  <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
  <div class="buttons">
    <button data-category="ì „ì²´" class="active">ì „ì²´</button>
    <button data-category="í•œì‹">í•œì‹</button>
    <button data-category="ì¤‘ì‹">ì¤‘ì‹</button>
    <button data-category="ì¼ì‹">ì¼ì‹</button>
    <button data-category="ë¶„ì‹">ë¶„ì‹</button>
    <button data-category="ì¹´í˜">ì¹´í˜</button>
  </div>

  <!-- ğŸ“Œ ìŒì‹ì  ë“±ë¡ í¼ -->
  <form id="placeForm" style="margin-bottom: 20px;">
    <h3>ìŒì‹ì  ë“±ë¡</h3>
    <input type="text" id="name" placeholder="ì´ë¦„" required />
    <input type="number" id="lat" placeholder="ìœ„ë„" required step="any" />
    <input type="number" id="lng" placeholder="ê²½ë„" required step="any" />
    <input type="text" id="category" placeholder="ì¹´í…Œê³ ë¦¬" required />
    <input type="text" id="description" placeholder="ì„¤ëª…" required />
    <button type="submit">ë“±ë¡</button>
  </form>


  <div id="map"></div>

  <script>
    function getDistance(lat1, lng1, lat2, lng2) {
      return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lng1 - lng2, 2));
    }

    window.onload = function () {
      kakao.maps.load(function () {
        var mapContainer = document.getElementById('map');
        var mapOption = {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 5
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        let allMarkers = [];

        fetch("http://localhost:3000/places")
          .then(res => res.json())
          .then(markerData => {
            // ë§ˆì»¤ ìƒì„±
            markerData.forEach(function (place) {
              const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(place.lat, place.lng),
                map: map,
                title: place.name
              });

              const infoWindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;">${place.name}</div>`
              });

              kakao.maps.event.addListener(marker, 'mouseover', function () {
                infoWindow.open(map, marker);
              });
              kakao.maps.event.addListener(marker, 'mouseout', function () {
                infoWindow.close();
              });

              allMarkers.push({
                marker: marker,
                category: place.category
              });
            });

            // ìœ„ì¹˜ ê¸°ë°˜ ì¶”ì²œ ë§ˆì»¤ í‘œì‹œ
            navigator.geolocation.getCurrentPosition(function (position) {
              const userLat = position.coords.latitude;
              const userLng = position.coords.longitude;
              const userLocation = new kakao.maps.LatLng(userLat, userLng);
              map.setCenter(userLocation);

              const userMarker = new kakao.maps.Marker({
                position: userLocation,
                map: map,
                title: "ğŸ“ ë‚´ ìœ„ì¹˜"
              });

              const recommendIcon = new kakao.maps.MarkerImage(
                "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
                new kakao.maps.Size(24, 35)
              );

              const distances = markerData.map(place => {
                const dist = getDistance(userLat, userLng, place.lat, place.lng);
                return { ...place, dist };
              });

              const top3 = distances.sort((a, b) => a.dist - b.dist).slice(0, 3);
              top3.forEach(place => {
                const pos = new kakao.maps.LatLng(place.lat, place.lng);
                const marker = new kakao.maps.Marker({
                  position: pos,
                  map: map,
                  title: `â­ ì¶”ì²œ: ${place.name}`,
                  image: recommendIcon
                });

                const infoWindow = new kakao.maps.InfoWindow({
                  content: `<div style="padding:5px;">â­ ${place.name}</div>`
                });

                kakao.maps.event.addListener(marker, 'mouseover', function () {
                  infoWindow.open(map, marker);
                });
                kakao.maps.event.addListener(marker, 'mouseout', function () {
                  infoWindow.close();
                });
              });
            });
          });

        // í•„í„° ë²„íŠ¼ í´ë¦­ ì‹œ ë§ˆì»¤ í•„í„°ë§
        const buttons = document.querySelectorAll(".buttons button");
        buttons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const category = this.getAttribute("data-category");

            buttons.forEach(b => b.classList.remove("active"));
            this.classList.add("active");

            allMarkers.forEach(obj => {
              if (category === "ì „ì²´" || obj.category === category) {
                obj.marker.setMap(map);
              } else {
                obj.marker.setMap(null);
              }
            });
          });
        });
      });
      // âœ… ìŒì‹ì  ë“±ë¡ ì²˜ë¦¬
      document.getElementById("placeForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const newPlace = {
          name: document.getElementById("name").value,
          lat: parseFloat(document.getElementById("lat").value),
          lng: parseFloat(document.getElementById("lng").value),
          category: document.getElementById("category").value,
          description: document.getElementById("description").value,
        };

        fetch("http://localhost:3000/places", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newPlace)
        })
          .then(res => {
            if (!res.ok) throw new Error("ë“±ë¡ ì‹¤íŒ¨");
            alert("ë“±ë¡ ì™„ë£Œ!");
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë§ˆì»¤ ë°˜ì˜
          })
          .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
      });
    };
  </script>
</body>

</html>