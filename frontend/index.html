<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <title>EdgeCacheMap</title>
  <script type="text/javascript"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8dc498e5a0513820fb29762cc5b64689&autoload=false&libraries=services"
    defer></script>
  <style>
    #map {
      width: 100%;
      height: 600px;
    }

    .buttons {
      margin: 10px 0;
    }

    .buttons button {
      margin-right: 5px;
      padding: 6px 12px;
      border: none;
      background-color: #eee;
      cursor: pointer;
    }

    .buttons button.active {
      background-color: #007bff;
      color: white;
    }

    #info {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="mainApp" style="display: none;">
    <h2>ğŸ“ ë‚˜ë§Œì˜ ìŒì‹ ë„ê°</h2>
    <div class="buttons">
      <button data-category="ì „ì²´" class="active">ì „ì²´</button>
      <button data-category="í•œì‹">í•œì‹</button>
      <button data-category="ì¤‘ì‹">ì¤‘ì‹</button>
      <button data-category="ì–‘ì‹">ì–‘ì‹</button>
      <button data-category="ì¼ì‹">ì¼ì‹</button>
      <button data-category="ë¶„ì‹">ë¶„ì‹</button>
      <button data-category="ì¹´í˜">ì¹´í˜</button>
    </div>
    <h3>ğŸ´ ìŒì‹ì  ë“±ë¡</h3>
    <div>
      <input id="name" placeholder="ìŒì‹ì  ì´ë¦„">
      <input id="lat" placeholder="ìœ„ë„">
      <input id="lng" placeholder="ê²½ë„">
      <input id="category" placeholder="ì¹´í…Œê³ ë¦¬ (í•œì‹/ì¤‘ì‹ ë“±)">
      <input id="description" placeholder="ì„¤ëª…">
      <button onclick="registerPlace()">ë“±ë¡</button>
    </div>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="map"></div>
    <div id="info">ìŒì‹ì ì„ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <div id="authSection">
    <h2>ğŸ” ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
    <input id="username" placeholder="ì•„ì´ë””">
    <input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password">
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <button onclick="register()">íšŒì›ê°€ì…</button>
  </div>
  <!-- ë§ˆì»¤ ìš°í´ë¦­ ì‹œ ëœ¨ëŠ” ë©”ë‰´ -->
  <div id="contextMenu" style="
  display: none;
  position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  padding: 5px;
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  ">
    <div id="editPlaceBtn" style="cursor:pointer;">âœ ìˆ˜ì •</div>
    <div id="deletePlaceBtn" style="cursor:pointer;">ğŸ—‘ ì‚­ì œ</div>
  </div>


  <script>
    let selectedPlaceForAction = null;
    let selectedPlaceId = null;
    let tempClickMarker = null;



    function getDistance(lat1, lng1, lat2, lng2) {
      return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lng1 - lng2, 2));
    }

    function registerPlace() {
      const token = localStorage.getItem("token"); // ë¡œê·¸ì¸ í›„ ì €ì¥ëœ í† í°
      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      const name = document.getElementById("name").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const category = document.getElementById("category").value;
      const description = document.getElementById("description").value;

      fetch("http://localhost:3000/places", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ name, lat, lng, category, description })
      })
        .then(res => res.json())
        .then(data => {
          console.log("ë“±ë¡ ê²°ê³¼:", data);
          alert("ìŒì‹ì  ë“±ë¡ ì™„ë£Œ!");
        })
        .catch(err => {
          console.error("ë“±ë¡ ì˜¤ë¥˜:", err);
          alert("ë“±ë¡ ì‹¤íŒ¨!");
        });
    }

    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      fetch("http://localhost:3000/auth/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ username, password })
      })
        .then(res => res.json())
        .then(data => {
          if (data.token) {
            localStorage.setItem("token", data.token);  // âœ… í† í° ì €ì¥
            alert("ë¡œê·¸ì¸ ì„±ê³µ!");
            document.getElementById("authSection").style.display = "none";
            document.getElementById("mainApp").style.display = "block"; // âœ… ì§€ë„ UI ë³´ì´ê¸°
          } else {
            alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + data.message);
          }
        })
        .catch(err => {
          console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", err);
          alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        });
    }
    function logout() {
      localStorage.removeItem("token");
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("authSection").style.display = "block";
    }


    function register() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      fetch("http://localhost:3000/auth/register", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ username, password })
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
        })
        .catch(err => {
          console.error("íšŒì›ê°€ì… ì˜¤ë¥˜:", err);
          alert("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        });
    }

    function updatePlace() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }
      if (!selectedPlaceId) {
        alert("ìˆ˜ì •í•  ìŒì‹ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const name = document.getElementById("name").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const category = document.getElementById("category").value;
      const description = document.getElementById("description").value;

      fetch(`http://localhost:3000/places/${selectedPlaceId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ name, lat, lng, category, description })
      })
        .then(res => res.json())
        .then(data => {
          console.log("ìˆ˜ì • ê²°ê³¼:", data);
          alert("ìŒì‹ì  ìˆ˜ì • ì™„ë£Œ!");
          location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ë°˜ì˜ í™•ì¸
        })
        .catch(err => {
          console.error("ìˆ˜ì • ì˜¤ë¥˜:", err);
          alert("ìˆ˜ì • ì‹¤íŒ¨!");
        });
    }

    function hideContextMenu() {
      document.getElementById("contextMenu").style.display = "none";
    }



    window.onload = function () {
      const token = localStorage.getItem("token");

      if (token) {
        // ìë™ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
        document.getElementById("authSection").style.display = "none";
        document.getElementById("mainApp").style.display = "block";

        initMap(); // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
      } else {
        // ë¡œê·¸ì¸ ì•ˆëœ ìƒíƒœë©´ ë¡œê·¸ì¸ UIë§Œ í‘œì‹œ
        document.getElementById("authSection").style.display = "block";
      }
    };

    async function initMap() {
      kakao.maps.load(async function () {
        const ps = new kakao.maps.services.Places();
        const mapContainer = document.getElementById('map');
        const mapOption = {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 5
        };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        const recommendIcon = new kakao.maps.MarkerImage(
          "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
          new kakao.maps.Size(24, 35)
        );

        let allMarkers = [];
        let recommendedMarkers = [];

        //DBì—ì„œ ìŒì‹ì  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const token = localStorage.getItem("token");
        const res = await fetch("http://localhost:3000/places/my-places", {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });
        const markerData = await res.json();


        navigator.geolocation.getCurrentPosition(function (position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const userLocation = new kakao.maps.LatLng(userLat, userLng);

          map.setCenter(userLocation);

          new kakao.maps.Marker({
            position: userLocation,
            map: map,
            title: "ğŸ“ ë‚´ ìœ„ì¹˜"
          });

          // ì¶”ì²œ ë§ˆì»¤ ê³„ì‚° í•¨ìˆ˜
          async function updateRecommendedMarkers(category, userLat, userLng) {
            recommendedMarkers.forEach(marker => marker.setMap(null));
            recommendedMarkers = [];

            try {
              const token = localStorage.getItem("token");

              const res = await fetch(
                `http://localhost:3000/places/recommend?lat=${userLat}&lng=${userLng}&category=${category}`,
                {
                  headers: {
                    "Authorization": `Bearer ${token}`
                  }
                }
              );

              const recommendedPlaces = await res.json();

              if (!Array.isArray(recommendedPlaces)) {
                throw new Error("ì‘ë‹µì´ ë°°ì—´ í˜•íƒœê°€ ì•„ë‹™ë‹ˆë‹¤.");
              }

              recommendedPlaces.forEach(place => {
                const pos = new kakao.maps.LatLng(place.lat, place.lng);
                const marker = new kakao.maps.Marker({
                  position: pos,
                  map: map,
                  title: `â­ ì¶”ì²œ: ${place.name}`,
                  image: recommendIcon
                });

                const infoWindow = new kakao.maps.InfoWindow({
                  content: `<div style="padding:5px;">â­ ${place.name}</div>`
                });

                kakao.maps.event.addListener(marker, 'mouseover', () => infoWindow.open(map, marker));
                kakao.maps.event.addListener(marker, 'mouseout', () => infoWindow.close());

                kakao.maps.event.addListener(marker, 'click', () => {
                  document.getElementById("info").innerHTML = `
          <strong>${place.name}</strong><br>
          ìœ„ë„: ${place.lat}<br>
          ê²½ë„: ${place.lng}<br>
          ì¹´í…Œê³ ë¦¬: ${place.category}<br>
          ì„¤ëª…: ${place.description || "ì—†ìŒ"}
        `;
                });

                kakao.maps.event.addListener(marker, "rightclick", function () {
                  selectedPlaceForAction = place;

                  const projection = map.getProjection();
                  if (!projection) return;

                  const point = projection.containerPointFromCoords(pos);
                  const mapContainer = document.getElementById("map");
                  const mapRect = mapContainer.getBoundingClientRect();

                  const menu = document.getElementById("contextMenu");
                  menu.style.left = mapRect.left + point.x + "px";
                  menu.style.top = mapRect.top + point.y + "px";
                  menu.style.display = "block";
                });

                recommendedMarkers.push(marker);
              });

            } catch (error) {
              console.error("ì¶”ì²œ ë§ˆì»¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }
          }


          // ë§µ í´ë¦­ ì‹œ ë©”ë‰´ì°½ ìˆ¨ê¸°ê¸°
          kakao.maps.event.addListener(map, "click", function () {
            document.getElementById("contextMenu").style.display = "none";
          });


          //ì¼ë°˜ ë§ˆì»¤ ìƒì„±
          markerData.forEach(place => {
            const markerPosition = new kakao.maps.LatLng(place.lat, place.lng);
            const marker = new kakao.maps.Marker({
              position: markerPosition,
              map: map,
              title: place.name
            });

            const infoWindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;">${place.name}</div>`
            });

            kakao.maps.event.addListener(marker, 'mouseover', () => infoWindow.open(map, marker));
            kakao.maps.event.addListener(marker, 'mouseout', () => infoWindow.close());
            kakao.maps.event.addListener(marker, 'click', function () {
              document.getElementById("info").innerHTML = `
    <strong>${place.name}</strong><br>
    ìœ„ë„: ${place.lat}<br>
    ê²½ë„: ${place.lng}<br>
    ì¹´í…Œê³ ë¦¬: ${place.category}<br>
    ì„¤ëª…: ${place.description || "ì—†ìŒ"}
  `;
            });

            kakao.maps.event.addListener(marker, "rightclick", function () {
              selectedPlaceForAction = place;

              const projection = map.getProjection();
              if (!projection) return;

              const point = projection.containerPointFromCoords(markerPosition);
              const mapContainer = document.getElementById("map");
              const mapRect = mapContainer.getBoundingClientRect();

              const menu = document.getElementById("contextMenu");
              menu.style.left = mapRect.left + point.x + "px";
              menu.style.top = mapRect.top + point.y + "px";
              menu.style.display = "block";
            });

            allMarkers.push({ marker, category: place.category });
          });


          // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
          document.getElementById("editPlaceBtn").addEventListener("click", async function () {
            if (!selectedPlaceForAction) return;

            const newName = prompt("ìƒˆ ìŒì‹ì  ì´ë¦„:", selectedPlaceForAction.name);
            const newDesc = prompt("ìƒˆ ì„¤ëª…:", selectedPlaceForAction.description);

            if (!newName || !newDesc) return;

            const token = localStorage.getItem("token");
            try {
              const res = await fetch(`http://localhost:3000/places/${selectedPlaceForAction._id}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                  name: newName,
                  lat: selectedPlaceForAction.lat,
                  lng: selectedPlaceForAction.lng,
                  category: selectedPlaceForAction.category,
                  description: newDesc
                })
              });

              const updated = await res.json();
              alert("ìˆ˜ì • ì™„ë£Œ!");

              // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
              const index = allMarkers.findIndex(obj => obj.marker.getPosition().getLat() === selectedPlaceForAction.lat && obj.marker.getPosition().getLng() === selectedPlaceForAction.lng);
              if (index !== -1) {
                allMarkers[index].marker.setMap(null);
                allMarkers.splice(index, 1); // ëª©ë¡ì—ì„œë„ ì œê±°
              }

              // ìƒˆ ë§ˆì»¤ ìƒì„±
              const markerPosition = new kakao.maps.LatLng(selectedPlaceForAction.lat, selectedPlaceForAction.lng);
              const newMarker = new kakao.maps.Marker({
                position: markerPosition,
                map: map,
                title: newName
              });

              const infoWindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;">${newName}</div>`
              });

              kakao.maps.event.addListener(newMarker, 'mouseover', () => infoWindow.open(map, newMarker));
              kakao.maps.event.addListener(newMarker, 'mouseout', () => infoWindow.close());
              kakao.maps.event.addListener(newMarker, 'click', function () {
                document.getElementById("info").innerHTML = `
        <strong>${newName}</strong><br>
        ìœ„ë„: ${selectedPlaceForAction.lat}<br>
        ê²½ë„: ${selectedPlaceForAction.lng}<br>
        ì¹´í…Œê³ ë¦¬: ${selectedPlaceForAction.category}<br>
        ì„¤ëª…: ${newDesc || "ì—†ìŒ"}
      `;
              });
              kakao.maps.event.addListener(newMarker, "rightclick", function () {
                selectedPlaceForAction = { ...selectedPlaceForAction, name: newName, description: newDesc };
                const projection = map.getProjection();
                if (!projection) return;
                const point = projection.containerPointFromCoords(markerPosition);
                const mapRect = document.getElementById("map").getBoundingClientRect();
                const menu = document.getElementById("contextMenu");
                menu.style.left = mapRect.left + point.x + "px";
                menu.style.top = mapRect.top + point.y + "px";
                menu.style.display = "block";
              });

              // 3ï¸âƒ£ ìƒˆ ë§ˆì»¤ ëª©ë¡ì— ì¶”ê°€
              allMarkers.push({
                marker: newMarker,
                category: selectedPlaceForAction.category
              });

              // 4ï¸âƒ£ selectedPlaceForAction ê°±ì‹ 
              selectedPlaceForAction.name = newName;
              selectedPlaceForAction.description = newDesc;

            } catch (err) {
              alert("ìˆ˜ì • ì‹¤íŒ¨");
              console.error(err);
            }

            hideContextMenu();
          });


          //  ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
          document.getElementById("deletePlaceBtn").addEventListener("click", function () {
            if (selectedPlaceForAction) {
              const token = localStorage.getItem("token");
              if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch(`http://localhost:3000/places/${selectedPlaceForAction._id}`, {
                  method: "DELETE",
                  headers: {
                    "Authorization": `Bearer ${token}`
                  }
                })
                  .then(res => res.json())
                  .then(data => {
                    alert("ì‚­ì œ ì™„ë£Œ!");
                    location.reload();
                  })
                  .catch(err => {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                    console.error(err);
                  });
              }
            }
            hideContextMenu();
          });

          // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
          kakao.maps.event.addListener(map, "click", function (mouseEvent) {
            hideContextMenu();

            const lat = mouseEvent.latLng.getLat();
            const lng = mouseEvent.latLng.getLng();

            // ë“±ë¡ëœ ë§ˆì»¤ì¸ì§€ í™•ì¸
            const clickedMarkers = allMarkers.filter(obj =>
              getDistance(lat, lng, obj.marker.getPosition().getLat(), obj.marker.getPosition().getLng()) < 0.00005
            );
            if (clickedMarkers.length > 0) return;

            // ìœ„,ê²½ë„ ì…ë ¥
            document.getElementById("lat").value = lat;
            document.getElementById("lng").value = lng;

            //  ìƒí˜¸ëª… ìë™ì…ë ¥
            ps.keywordSearch('', function (data, status, pagination) {
              if (status === kakao.maps.services.Status.OK && data.length > 0) {
                // ê°€ì¥ ê°€ê¹Œìš´ ì¥ì†Œëª… ì‚¬ìš©
                const nearest = data[0];
                document.getElementById("name").value = nearest.place_name;
              } else {
                // fallback: ì£¼ì†Œ ì´ë¦„ ì‚¬ìš©
                const geocoder = new kakao.maps.services.Geocoder();
                geocoder.coord2Address(lng, lat, function (result, status) {
                  if (status === kakao.maps.services.Status.OK) {
                    const info = result[0].road_address || result[0].address;
                    if (info && info.address_name) {
                      document.getElementById("name").value = info.address_name;
                    }
                  }
                });
              }
            }, {
              location: new kakao.maps.LatLng(lat, lng),
              radius: 30 // meters, 30~50 ì •ë„ê°€ ì ë‹¹
            });

            // ê¸°ì¡´ ì„ì‹œ ë§ˆì»¤ ì œê±°
            if (tempClickMarker) tempClickMarker.setMap(null);

            tempClickMarker = new kakao.maps.Marker({
              position: mouseEvent.latLng,
              map: map,
              title: "ë“±ë¡ ìœ„ì¹˜"
            });
          });

          //ë²„íŠ¼ í´ë¦­ í•„í„°
          const buttons = document.querySelectorAll(".buttons button");
          buttons.forEach(btn => {
            btn.addEventListener("click", function () {
              const selectedCategory = this.dataset.category;

              buttons.forEach(b => b.classList.remove("active"));
              this.classList.add("active");

              allMarkers.forEach(obj => {
                if (selectedCategory === "ì „ì²´" || obj.category === selectedCategory) {
                  obj.marker.setMap(map);
                } else {
                  obj.marker.setMap(null);
                }
              });

              updateRecommendedMarkers(selectedCategory, userLat, userLng);
            });
          });

          updateRecommendedMarkers("ì „ì²´", userLat, userLng);

        }, function () {
          alert("ìœ„ì¹˜ ì ‘ê·¼ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.");
        });
      });
    };


  </script>


</body>

</html>